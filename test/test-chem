#!/usr/bin/env Rscript
# vi: ft=R
library(RUnit, quietly = TRUE)
args <- commandArgs(trailingOnly = F)
script.path <- sub("--file=","",args[grep("--file",args)])
source(file.path(dirname(script.path), '..', 'chem.R'), chdir = TRUE)

#################
# TEST LOAD SDF #
#################

test.load.sdf <- function() {

	library(rJava)

	# Bad file
	checkTrue(is.null(load.sdf('toto.sdf')))

	# Read file
	file <- file.path(dirname(script.path), 'files', 'results_2_MSMS.txt-chemspider.sdf')
	mols <- load.sdf(file)
	checkTrue( ! is.null(mols))
	checkEquals(length(mols$struct), nrow(mols$info))

	# Check SMILES
#	print(colnames(mols$info))
#	if ('SMILES' %in% colnames(mols$info))
#		for (i in seq(mols$struct)) {
#			print(get.smiles(mols$struct[[i]]))
#			print(get.InChi(mols$struct[[i]]))
#				print(mols$info[i, 'SMILES'])
#			checkEquals(get.smiles(mols$struct[[i]]), mols$info[i, 'SMILES'])
#
#		}

	cp = c(Sys.glob(file.path("/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rcdk/cont", "*.jar")),
	       Sys.glob(file.path("/Library/Frameworks/R.framework/Versions/3.2/Resources/library/rcdklibs/cont", "*.jar")))
	.jaddClassPath(cp)

	# Check InChIs
	print(colnames(mols$info))
	if ('InChI' %in% colnames(mols$info))
		for (i in seq(mols$struct)) {
			inchi <- .jcall('org/guha/rcdk/util/Misc', 'S', 'getInChi', mols$struct[[i]])
#			inchi <- J("org.openscience.cdk.inchi.InChIGeneratorFactory")$getInstance()$getInChIGenerator(mols$struct[[i]])$getInChI()
				print(inchi)
		}
}

##################
# TEST GET INCHI #
##################

test.get.inchi <- function() {
	file <- file.path(dirname(script.path), 'files', 'results_2_MSMS.txt-chemspider.sdf')
	mols <- load.sdf(file)
		for (i in seq(mols$struct)) {
	checkTrue( ! is.na(get.inchi(mols$struct[[i]])))
	print(get.inchi(mols$struct[[i]]))
		}
}

########
# MAIN #
########

test.get.inchi()
test.load.sdf()
